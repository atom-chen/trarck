var exec = require('child_process').exec;var WorkPool=require('./WorkPool').WorkPool;var Download=require('./Download').Download;var DownloadAsset=require('./DownloadAsset').DownloadAsset;var Util=require('./Util').Util;var configs=require('./configs').configs;//second manifestsvar args=process.argv.slice(2);var target=args[0] || "kr";var targetConfig=configs[target];targetConfig.sdcardSDKRoot=Util.checkDirEndChar(targetConfig.sdcardSDKRoot);targetConfig.sdcardGamePath=targetConfig.sdcardGamePath?targetConfig.sdcardGamePath:targetConfig.sdcardSDKRoot+Util.md5(targetConfig.gameUrl);targetConfig.sdcardGamePath=Util.checkDirEndChar(targetConfig.sdcardGamePath);targetConfig.gameUrl=Util.checkDirEndChar(targetConfig.gameUrl);targetConfig.secondContentUrl=Util.checkDirEndChar(targetConfig.secondContentUrl);var region=targetConfig.region;var gameUrl=targetConfig.gameUrl;var secondContentUrl=targetConfig.secondContentUrl;var outDir="werule_"+target+"/";var platform=args[1] || targetConfig.plateform || "android";//download configurationvar configurationUrl=gameUrl+platform+"/configuration.json";//second manifestvar manifests=[];//level manifestsvar maxLevel=5;for(var l=1;l<=maxLevel;l++){    manifests.push("webgame.level_"+(l<10?"00"+l:(l<100?"0"+l:l))+"_android.ngmanifest");}console.log("manifests:",manifests);var downloadManifestWP=new WorkPool(1,"download manifest");downloadManifestWP.add(downloadMainManifest);downloadManifestWP.add(downloadSecondManifest);downloadManifestWP.join(pushToSdcard);// pushToSdcard();function downloadMainManifest(mainTask){	//TODO check is downloaded		Download.downloadRetry(Download.download,configurationUrl,function (data) {		console.log("download sucess url="+configurationUrl);		console.log("configuration:"+data);		var configuration=JSON.parse(data);	    //main manifest	    var mainDownload=new DownloadAsset();	    mainDownload.setup({	        contentUrl:configuration.contentUrl+"/",	        localPath:outDir	    });	    mainDownload.start("webgame.ngmanifest",function () {			//downloadSecondManifest();				mainTask.done();	    });	},function(){		console.log("download fail url="+configurationUrl);	});}function downloadSecondManifest (mainTask) {    var manifestList=secondContentUrl+platform+"/manifest_list/"+region+"_"+platform+"_manifest_list.json";    Download.downloadRetry(Download.download,manifestList,function (data) {        console.log("manifestList:"+data);        var manifestList=JSON.parse(data);        if(manifestList["download-now"]){            var downloadNow=manifestList["download-now"];            for(var i in downloadNow){                manifests.push(downloadNow[i].manifestName);            }        }                //start down        var contentUrl=secondContentUrl+platform+"/";        var wp=new WorkPool(3,"seconde manifest");        for(var i=0,l=manifests.length;i<l;i++){            wp.add(			(function(manifestName){				return function (task) {	                var secondDownload=new DownloadAsset();	                secondDownload.setup({	                    contentUrl:contentUrl,	                    localPath:outDir	                });	                secondDownload.start(manifestName,function(){	                    task.done();	                });				};            })(manifests[i]));        }				wp.join(function(){			//pushToSdcard();			mainTask.done();		});    },function(){        console.log("download fail url="+manifestList);    });}function pushToSdcard(){	var cmd="adb push "+outDir+" "+targetConfig.sdcardGamePath;	console.log("pushToSdcard:"+cmd);	exec(cmd);}